#!/bin/bash
# =====================================================================
# –°–û–ó–î–ê–ù–ò–ï –§–ê–ô–õ–û–í –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê –ò–ó –°–ö–û–ü–ò–†–û–í–ê–ù–ù–û–ì–û –°–û–î–ï–†–ñ–ò–ú–û–ì–û
# –í–µ—Ä—Å–∏—è: create-1.0
# =====================================================================
set -euo pipefail

# ‚îÄ‚îÄ‚îÄ —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'
info(){ echo -e "${BLUE}[INFO]${NC} $1"; }
good(){ echo -e "${GREEN}[ OK ]${NC} $1"; }
warn(){ echo -e "${YELLOW}[WARN]${NC} $1"; }
fail(){ echo -e "${RED}[ERR]${NC} $1"; exit 1; }

[[ $EUID -ne 0 ]] && fail "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —á–µ—Ä–µ–∑ sudo"

echo "üîß –°–û–ó–î–ê–ù–ò–ï –§–ê–ô–õ–û–í –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê TIMEWEB"
echo "======================================="
echo ""

# ‚îÄ‚îÄ‚îÄ –≤–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
read -p "–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: " DOMAIN

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p /etc/ssl/{certs,private}

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo ""
echo "üìã –°–û–ó–î–ê–ù–ò–ï –§–ê–ô–õ–ê –°–ï–†–¢–ò–§–ò–ö–ê–¢–ê"
echo "============================="
echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏–∑ –ø–∞–Ω–µ–ª–∏ Timeweb"
echo "2. –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –Ω–∏–∂–µ (–≤–∫–ª—é—á–∞—è BEGIN –∏ END —Å—Ç—Ä–æ–∫–∏)"
echo "3. –ù–∞–∂–º–∏—Ç–µ Ctrl+D –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ"
echo ""
echo "–í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:"

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
temp_cert=$(mktemp)
cat > "$temp_cert"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
if ! openssl x509 -in "$temp_cert" -text -noout >/dev/null 2>&1; then
    fail "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
echo ""
echo "üîë –°–û–ó–î–ê–ù–ò–ï –§–ê–ô–õ–ê –ü–†–ò–í–ê–¢–ù–û–ì–û –ö–õ–Æ–ß–ê"
echo "=================================="
echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ø–∞–Ω–µ–ª–∏ Timeweb"
echo "2. –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –Ω–∏–∂–µ (–≤–∫–ª—é—á–∞—è BEGIN –∏ END —Å—Ç—Ä–æ–∫–∏)"
echo "3. –ù–∞–∂–º–∏—Ç–µ Ctrl+D –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ"
echo ""
echo "–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á:"

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –∫–ª—é—á–∞
temp_key=$(mktemp)
cat > "$temp_key"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–∞
if ! openssl rsa -in "$temp_key" -check -noout >/dev/null 2>&1; then
    fail "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –∫–ª—é—á–∞
cert_modulus=$(openssl x509 -in "$temp_cert" -noout -modulus | openssl md5)
key_modulus=$(openssl rsa -in "$temp_key" -noout -modulus | openssl md5)

if [[ "$cert_modulus" != "$key_modulus" ]]; then
    fail "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞ –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ
cert_domain=$(openssl x509 -in "$temp_cert" -noout -subject | grep -o "CN = [^,]*" | cut -d'=' -f2 | tr -d ' ')
if [[ "$cert_domain" != "$DOMAIN" ]]; then
    warn "–î–æ–º–µ–Ω –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ ($cert_domain) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ($DOMAIN)"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " continue_anyway
    if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
        rm -f "$temp_cert" "$temp_key"
        fail "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
expiry_date=$(openssl x509 -in "$temp_cert" -noout -enddate | cut -d'=' -f2)
expiry_timestamp=$(date -d "$expiry_date" +%s)
current_timestamp=$(date +%s)
days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))

if [[ $days_until_expiry -lt 0 ]]; then
    fail "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫: $expiry_date"
elif [[ $days_until_expiry -lt 30 ]]; then
    warn "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ $days_until_expiry –¥–Ω–µ–π: $expiry_date"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " continue_expired
    if [[ ! "$continue_expired" =~ ^[Yy]$ ]]; then
        rm -f "$temp_cert" "$temp_key"
        fail "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    fi
else
    good "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: $expiry_date ($days_until_expiry –¥–Ω–µ–π)"
fi

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
info "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
cp "$temp_cert" "/etc/ssl/certs/$DOMAIN.pem"

info "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞..."
cp "$temp_key" "/etc/ssl/private/$DOMAIN.key"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
chmod 644 "/etc/ssl/certs/$DOMAIN.pem"
chmod 600 "/etc/ssl/private/$DOMAIN.key"

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -f "$temp_cert" "$temp_key"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
if openssl x509 -in "/etc/ssl/certs/$DOMAIN.pem" -text -noout >/dev/null 2>&1; then
    good "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    fail "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if command -v nginx >/dev/null 2>&1; then
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
    if nginx -t >/dev/null 2>&1; then
        good "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        info "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
        systemctl reload nginx
        good "Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    else
        warn "–ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π Nginx"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é: nginx -t"
    fi
fi

good "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ï–†–¢–ò–§–ò–ö–ê–¢–ï:"
echo "   ‚Ä¢ –î–æ–º–µ–Ω: $DOMAIN"
echo "   ‚Ä¢ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: /etc/ssl/certs/$DOMAIN.pem"
echo "   ‚Ä¢ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á: /etc/ssl/private/$DOMAIN.key"
echo "   ‚Ä¢ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ: $expiry_date"
echo "   ‚Ä¢ –î–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è: $days_until_expiry"
echo ""
echo "üîß –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´:"
echo "   ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π: openssl x509 -in /etc/ssl/certs/$DOMAIN.pem -text -noout"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx: nginx -t"
echo "   ‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx: systemctl reload nginx" 